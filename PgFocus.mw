== Description ==

pgFocus is an open source and open hardware focus stabilization device developed by Karl Bellvé at the [http://big.umassmed.edu Biomedical Imaging Group] (PMM, University of Massachusetts Medical School).

The pg in pgFocus is short for "Pretty Good". pgFocus isn't "Perfect", or "Definite" but it is pretty good!

== Hardware ==

pgFocus uses the same [http://www.atmel.com/devices/ATMEGA32U4.aspx Atmel ATMEGA 32U4] as seen in the [http://arduino.cc/en/Main/arduinoBoardLeonardo Arduino Leonardo]. 

pgFocus is connected to a computer via a USB port. USB is used to power and to communicate with pgFocus.

Eagle files are located at [https://github.com/kbellve/pgFocus Github].

'''Warning:''' PCB design has not been verified yet and may not be final.

=== Optics ===

pgFocus uses a laser beam that is reflected off the cover glass/water interface to monitor the microscope focus. Hence, an objective with an NA of at least 1.45 is required.
The laser beam wavelength should be different from that being used for science (808nm is a good choice) and must be coaligned with the TIRF beam. This can be done using a mirror, beam splitter and a short pass filter. Care must be taken to ensure that the fluorescence filter cube and other microscope optics will allow the return of the pgFocus beam back along its input path and back to the pgFocus detector and that the microscope optics will NOT allow the laser light to pass into the user's eyes or to reach the camera. Once the position and angle of the pgFocus beam is coincident with that of the TIRF beam a strong return pgFocus beam will be seen that moves with changes in microscope focus. The pgFocus detector array can now be aligned and centered on the beam.

== Software ==

After the Arduino Leonardo was released, pgFocus was redesigned to take advantage of the bootloader designed for the Arduino Leonardo. If you can write an Arduino sketch, you can modify the source code to pgFocus!

pgFocus software reports the following:
* Light profile as seen by the Linear Light Array.
** Use this to align the physical position of pgFocus with respect to the return laser beam.
* Current centroid location of the light profile as seen by the Linear Light Array.
* Microscope stability based on the running Standard Deviation(converted to nM movement at the objective).
* Digital to Analog converter voltage output need to maintain current focus position.
* Calibration mode result.

pgFocus software can do the following:
* Lock focus at the current position.
* Move focus up by a specified amount (currently set to +50nM).
* Move focus down by a specified amount (currently set to -50nM).

pgFocus software has not be released yet since it was designed for the prototype version of pgFocus rather than this version. It will be released as soon as possible.

=== Calibration Mode ===

pgFocus needs to understand the relationship between the movement of the laser beam return signal seen on the Linear Light Array and the movement of the objective. This depends upon the location of pgFocus in relation to the objective. To determine this relationship, pgFocus has a calibration mode that moves the objective up and then down, while reading the position of the return laser beam. This information is plotted and a linear regression analysis is performed to determine the slope. The slope is the scale factor that pgFocus uses for calculations and for focus adjustments.

A calibration must be performed after first installing pgFocus, or if the distance between pgFocus or the objective changes (i.e. pgFocus is moved). 

The user just needs to make sure the the return laser beam is aligned and centered on the Linear Light Array. pgFocus will take care of the rest and will restore the resulting calculation in its EPROM.

== Performance ==

pgFocus is designed to track and control focus within ±3nM at 30Hz under optimal conditions (tested with a high NA 60X Objective plus 1.6X optivar).

[[Media:pgFocus.mov|Movie]] of pgFocus in action. 200nM beads were TIRF imaged with uManager's burst mode with a 60X objective with a 1.6X optivar. 

The microscope is enclosed in an environmental chamber. The doors to the chamber were opened at image 300 and closed at image 600. You will see a disturbance to the focus at both times, but focus is soon corrected within moments. The focus is disturbed due to the change in the temperature gradient across the microscope caused by the open doors.

Below is the graph of pgFocus performance from the above movie.

[[File:pgFocus_graph.png|frame|Figure: pgFocus in action. Doors to a microscope environmental chamber were opened at image 300 and then closed at image 600.]]


Below is the graph of what happens when pgFocus isn't controlling focus stabilization during the same procedure.

[[File:pgFocus_off.png|frame|Figure: pgFocus has been turned off, but the doors were opened and closed to the microscope chamber. Only plotting the Linear Light Array since no voltage is being applied to correct focus. ]]

== Parts ==

Preliminary parts list. Parts may change at any time.

{|border="1"  style="text-align:center;"
|-
!Name
!Current
!Voltage
!Reference
!Notes
|-
|TSL1401CL
|5mA
|5V
|[http://www.mouser.com/ProductDetail/ams/TSL1401CL/?qs=%2fha2pyFadui9qowM2EAvhG%2fJktwzmI3oPG4s%2fwQmRk8%3d Mouser] [http://octopart.com/tsl1401cl-taos-22060121 Octopart] 
|0.018 to 100ms Exposure Time
|-
|ATMEGA32U4
|7mA
|5V
|[http://www.atmel.com/devices/atmega32u4.aspx ATMEL] [http://www.newark.com/jsp/search/productdetail.jsp?sku=26R5633 Newark]
| 
|-
|AD8221ARZ
|1mA
| -12V to 12V
|[http://www.analog.com/en/specialty-amplifiers/instrumentation-amplifiers/ad8221/products/product.html Analog Devices] [http://www.analog.com/static/imported-files/data_sheets/AD8221.pdf PDF]
|
|-
|AD5531BRUZ
|2mA
| -12V to 12V
|[http://www.analog.com/en/digital-to-analog-converters/da-converters/ad5531/products/product.html Analog Devices]  [http://www.analog.com/static/imported-files/data_sheets/AD5530_5531.pdf PDF]
|
|-
|TC7660
|20mA
|5V to 10V, -5V
|[http://www.microchip.com/wwwproducts/Devices.aspx?dDocName=en010576 Microchip] [http://ww1.microchip.com/downloads/en/DeviceDoc/21465b.pdf PDF]  [http://www.newark.com/microchip/tc7660coa/ic-charge-pump-dc-dc-converter/dp/61K3539 Newark]
|10kHz. Use 10uF caps
|- 
|TC7660H
|
|5V to 10V, -5V
|[http://www.microchip.com/wwwproducts/Devices.aspx?dDocName=en010577 Microchip]   [http://ww1.microchip.com/downloads/en/DeviceDoc/21466a.pdf PDF] [http://www.newark.com/microchip/tc7660coa/ic-charge-pump-dc-dc-converter/dp/61K3539 Newark]  
|120kHz. Use 1uF caps
|-
|AD7894-10
|4mA
| -10V to 10V
|[http://www.analog.com/en/analog-to-digital-converters/ad-converters/ad7894/products/product.html Analog Devices]   [http://www.analog.com/static/imported-files/data_sheets/AD7894.pdf PDF]  [http://www.newark.com/analog-devices/ad7894arz-3/serial-14-bit-adc-i-c/dp/59K5904?in_merch=Popular%20Products Newark]
|Serial (not SPI or I2C), Using GAIN on 2 with op amp for -5 to +5V range
|-
|ADR03BRZ
|1mA
|2.5V reference
|[http://www.analog.com/en/special-linear-functions/voltage-references/adr03/products/product.html Analog Devices] [http://www.analog.com/static/imported-files/data_sheets/ADR01_02_03_06.pdf PDF][http://www.newark.com/analog-devices/adr03brz/ic-series-v-ref-2-5v-2-5mv-8-soic/dp/59K2682?in_merch=Popular%20Products Newark] 
|2.5V Reference
|-
|ADTL082
|1.2mA
|
|[http://www.analog.com/en/all-operational-amplifiers-op-amps/operational-amplifiers-op-amps/adtl082/products/product.html Analog Devices] [http://www.analog.com/static/imported-files/data_sheets/ADTL082_084.pdf PDF]
|Unity Gain Stable
|-
|RJ45-8PTH
|NA
|NA
|
|
|-
|USB Type B
|NA
|NA
|[http://www.newark.com/jsp/search/productdetail.jsp?sku=14N8154 Newark]
|
|-
| PTC Resettable Fuse
|500mA
|15V
|[http://www.newark.com/jsp/search/productdetail.jsp?sku=02J2730 Newark] 
|
|-
|Schottky Diode
|30mA
|30V
|[http://search.digikey.com/us/en/products/RB751G-40T2R/RB751G-40T2RDKR-ND/1801055 Digi-key]
|2-SMD, Flat Lead
|-
|Schottky Diode
|200mA
|40V
|[http://www.newark.com/jsp/search/productdetail.jsp?sku=75R5257 Newark]
|SOD-323
|-
|18pF Capacitor 
|
|50V
|[http://www.newark.com/jsp/search/productdetail.jsp?sku=06R5140 Newark]
|0603
|-
|100pF Capacitor 
|
|50V
|[http://www.newark.com/jsp/search/productdetail.jsp?sku=06R5119 Newark]
|0603
|-
|1000pF Capacitor 
|
|50V
|[http://www.newark.com/jsp/search/productdetail.jsp?sku=06R4910 Newark]
|0603
|-
|0.01uF Capacitor 
|
|50V
|[http://www.newark.com/jsp/search/productdetail.jsp?sku=06R4918 Newark]
|0603
|-
|0.1uF Capacitor 
|
|50V
|[http://www.newark.com/jsp/search/productdetail.jsp?sku=06R4927 Newark]
|0603
|-
|10uF Capacitor 
|
|16V
|[http://www.newark.com/jsp/search/productdetail.jsp?sku=59M9559 Newark]
|1206, ESR: 0.2ohm
|-
|10uF Capacitor 
|
|16V
|[http://www.newark.com/jsp/search/productdetail.jsp?sku=09K5840 Newark] [http://www.avx.com/docs/Catalogs/tcj.pdf PDF]
|1206, ESR: 3ohm
|-
|Enclosure
|
|
|[http://www.hammondmfg.com/1455NC.htm Hammond] [http://www.hammondmfg.com/pdf/1455NC1201.pdf PDF] 
|Part Number: 1455NC1201
|}


== Thanks ==

pgFocus couldn't have been designed without the support from the [http://www.umassmed.edu/pmm/index.aspx Program in Molecular Medicine] at [http://www.umassmed.edu Umass], and the following Open Software and Open Hardware communities:

*[http://valelab.ucsf.edu/~MM/MMwiki/index.php/Micro-Manager_Open_Source_Microscopy_Software uManager]

*[http://www.adafruit.com/ Adafruit industries]

*[http://www.sparkfun.com/ Sparkfun Electronics]

*[http://www.parallax.com/ Parallax Inc]

*[http://www.arduino.cc/ Arduino]
